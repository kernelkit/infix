#!/usr/bin/env python3

import sys
import subprocess
import json
import re

def get_stations(interface):
    """Get connected stations for an AP interface"""
    try:
        result = subprocess.run(['iw', 'dev', interface, 'station', 'dump'],
                              capture_output=True, text=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        return []

    stations = []
    station = None

    for line in result.stdout.split('\n'):
        line = line.strip()

        if line.startswith('Station'):
            if station:
                stations.append(station)
            mac = re.search(r'([a-fA-F0-9:]{17})', line)
            station = {
                'mac-address': mac.group(1) if mac else 'unknown',
                'rssi': 0,
                'tx-speed': 'unknown',
                'rx-speed': 'unknown',
                'connected-time': 'unknown'
            }

        elif station:
            if 'signal:' in line and 'avg' not in line:
                sig = re.search(r'signal:\s*(-?\d+)', line)
                if sig:
                    station['rssi'] = int(sig.group(1))
            elif 'tx bitrate:' in line:
                bitrate = re.search(r'tx bitrate:\s*(\d+\.?\d*)\s*(MBit/s|Gbit/s)', line)
                if bitrate:
                    station['tx-speed'] = f"{bitrate.group(1)} {bitrate.group(2).replace('Bit/s', 'bps')}"
            elif 'rx bitrate:' in line:
                bitrate = re.search(r'rx bitrate:\s*(\d+\.?\d*)\s*(MBit/s|Gbit/s)', line)
                if bitrate:
                    station['rx-speed'] = f"{bitrate.group(1)} {bitrate.group(2).replace('Bit/s', 'bps')}"
            elif 'connected time:' in line:
                time = re.search(r'connected time:\s*(\d+\s+\w+)', line)
                if time:
                    station['connected-time'] = time.group(1)

    if station:
        stations.append(station)

    return stations

if __name__ == "__main__":
    if len(sys.argv) != 2:
        sys.exit(1)

    print(json.dumps(get_stations(sys.argv[1]), indent=2))
